<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pingora • Modern Speed Test</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Use jsDelivr dist build (fixed version recommended) -->
    <script type="module">
        import SpeedTest from 'https://cdn.jsdelivr.net/npm/@cloudflare/speedtest@1.7.0/dist/speedtest.js';
        window.SpeedTest = SpeedTest;
    </script>

    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --accent: #06b6d4;
            --dark: #0f172a;
            --darker: #020617;
            --card: rgba(30, 41, 59, 0.7);
            --card-border: rgba(255, 255, 255, 0.1);
            --text: #f8fafc;
            --text-muted: #94a3b8;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --radius: 16px;
            --shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            --transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.08);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 100%);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 24px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 0;
            border-bottom: 1px solid var(--glass-border);
            margin-bottom: 40px;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(20px);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .logo { display: flex; align-items: center; gap: 16px; z-index: 1001; }
        .logo-icon {
            width: 50px; height: 50px; background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 12px; display: flex; align-items: center; justify-content: center;
            font-size: 26px; font-weight: 800; box-shadow: 0 8px 32px rgba(99, 102, 241, 0.4); animation: pulse 2s infinite;
        }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .logo-text { font-size: 34px; font-weight: 800;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        .hamburger { display:none; flex-direction:column; gap:6px; background:transparent; border:none; cursor:pointer; padding:12px; z-index:1001; }
        .hamburger span { width:30px; height:3px; background:var(--text); border-radius:3px; transition:var(--transition); }
        .hamburger.active span:nth-child(1) { transform: rotate(45deg) translate(8px, 8px); }
        .hamburger.active span:nth-child(2) { opacity: 0; }
        .hamburger.active span:nth-child(3) { transform: rotate(-45deg) translate(7px, -7px); }

        nav { display:flex; transition:var(--transition); }
        nav ul { display:flex; list-style:none; gap:32px; }
        nav a { color:var(--text-muted); text-decoration:none; font-weight:600; font-size:17px; padding:12px 24px; border-radius:var(--radius); transition:var(--transition); display:flex; align-items:center; gap:12px; border:2px solid transparent; }
        nav a:hover, nav a.active { color:var(--text); background:var(--glass); border-color:var(--glass-border); transform:translateY(-3px); box-shadow:0 10px 30px rgba(0,0,0,0.3); }
        .nav-icon { font-size:20px; }

        .page { display:none; animation: fadeIn 0.5s ease; }
        .page.active { display:block; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(30px);} to { opacity:1; transform:translateY(0);} }

        .page-header { margin-bottom:60px; text-align:center; }
        .page-header h1 { font-size:56px; font-weight:800; margin-bottom:20px; background: linear-gradient(to right, var(--primary), var(--secondary), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: gradientShift 8s infinite alternate; }
        @keyframes gradientShift { 0% { filter:hue-rotate(0deg);} 100% { filter:hue-rotate(30deg);} }
        .page-header p { font-size:20px; color:var(--text-muted); max-width:700px; margin:0 auto; line-height:1.7; }

        .test-container { background: linear-gradient(145deg, rgba(30,41,59,0.8), rgba(15,23,42,0.9)); border-radius:var(--radius); padding:60px; border:1px solid var(--glass-border); box-shadow:var(--shadow); margin-bottom:60px; position:relative; overflow:hidden; }
        .test-container::before { content:''; position:absolute; top:-50%; left:-50%; width:200%; height:200%; background: linear-gradient(45deg, transparent 30%, rgba(99,102,241,0.1) 50%, transparent 70%); animation: shine 8s infinite linear; z-index:0; }
        @keyframes shine { 0% { transform: translateX(-100%) translateY(-100%) rotate(45deg);} 100% { transform: translateX(100%) translateY(100%) rotate(45deg);} }

        .visualization { height:300px; background: rgba(0,0,0,0.3); border-radius:var(--radius); margin-bottom:60px; position:relative; overflow:hidden; border:1px solid var(--glass-border); z-index:1; }
        .speed-gauge { position:absolute; bottom:0; left:0; width:100%; height:0; background: linear-gradient(to top, var(--primary), var(--secondary), var(--accent)); transition: height 0.7s cubic-bezier(0.34,1.56,0.64,1); opacity:0.8; }

        .results-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap:30px; margin-bottom:60px; z-index:1; position:relative; }
        .result-card { background:var(--glass); backdrop-filter: blur(20px); border-radius:var(--radius); padding:40px 30px; text-align:center; border:1px solid var(--glass-border); transition:var(--transition); position:relative; overflow:hidden; }
        .result-card::before { content:''; position:absolute; top:0; left:0; width:100%; height:4px; background: linear-gradient(to right, var(--primary), var(--secondary)); }
        .result-card.active { transform:translateY(-15px); box-shadow: 0 30px 60px rgba(99,102,241,0.4); border-color:var(--primary); }
        .result-card h3 { font-size:18px; color:var(--text-muted); margin-bottom:20px; font-weight:600; text-transform:uppercase; letter-spacing:2px; }
        .result-value { font-size:56px; font-weight:800; line-height:1; margin-bottom:12px; font-variant-numeric:tabular-nums; background: linear-gradient(to right, var(--text), var(--accent)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
        .result-unit { font-size:18px; color:var(--text-muted); }

        #ping .result-value { color:var(--success); }
        #download .result-value { color:var(--primary); }
        #upload .result-value { color:var(--secondary); }
        #jitter .result-value { color:var(--accent); }

        .progress-container { margin:60px 0; z-index:1; position:relative; }
        .progress-bar { height:14px; background: rgba(255,255,255,0.08); border-radius:7px; overflow:hidden; margin-bottom:20px; border:1px solid var(--glass-border); }
        .progress-fill { height:100%; background: linear-gradient(90deg, var(--primary), var(--secondary), var(--accent)); width:0%; transition: width 0.25s linear; }
        .progress-text { display:flex; justify-content:space-between; font-size:16px; color:var(--text-muted); }

        .test-controls { display:flex; justify-content:center; gap:30px; margin-top:50px; z-index:1; position:relative; }
        .btn { padding:22px 48px; border:none; border-radius:var(--radius); font-size:20px; font-weight:700; cursor:pointer; transition:var(--transition); display:flex; align-items:center; justify-content:center; gap:16px; min-width:260px; backdrop-filter: blur(20px); letter-spacing:1px; }
        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color:white; border:2px solid rgba(255,255,255,0.15); box-shadow:0 15px 40px rgba(99,102,241,0.5); }
        .btn-primary:hover:not(:disabled) { transform: translateY(-8px) scale(1.05); box-shadow: 0 25px 60px rgba(99,102,241,0.7); }
        .btn-secondary { background:var(--glass); color:var(--text); border:2px solid var(--glass-border); }
        .btn-secondary:hover:not(:disabled) { background: rgba(255,255,255,0.12); transform:translateY(-8px); box-shadow:0 20px 50px rgba(0,0,0,0.4); }
        .btn:disabled { opacity:0.5; cursor:not-allowed; transform:none !important; box-shadow:none !important; }

        .content-container { background: linear-gradient(145deg, rgba(30,41,59,0.8), rgba(15,23,42,0.9)); border-radius:var(--radius); padding:50px; border:1px solid var(--glass-border); box-shadow:var(--shadow); margin-bottom:60px; }
        .history-list, .server-list, .settings-group, .faq-list { list-style:none; }
        .history-item, .server-item, .setting-item, .faq-item { background:var(--glass); backdrop-filter: blur(20px); border-radius:var(--radius); padding:30px; border:1px solid var(--glass-border); margin-bottom:25px; transition:var(--transition); }
        .history-item:hover, .server-item:hover, .setting-item:hover, .faq-item:hover { transform:translateX(10px); border-color:var(--primary); box-shadow:0 20px 40px rgba(0,0,0,0.3); }

        .history-stats, .server-stats { display:flex; gap:40px; text-align:center; }
        .stat-value, .server-ping { font-size:32px; font-weight:800; display:block; }
        .stat-label, .server-ping-label { font-size:16px; color:var(--text-muted); }

        .server-status { width:14px; height:14px; border-radius:50%; background:var(--success); box-shadow:0 0 15px var(--success); }

        .toggle-switch { position:relative; display:inline-block; width:68px; height:34px; }
        .toggle-switch input { opacity:0; width:0; height:0; }
        .toggle-slider { position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background: rgba(255,255,255,0.1); border-radius:34px; transition:var(--transition); border:2px solid var(--glass-border); }
        .toggle-slider:before { position:absolute; content:""; height:26px; width:26px; left:4px; bottom:4px; background:white; border-radius:50%; transition:var(--transition); }
        input:checked + .toggle-slider { background:var(--primary); border-color:var(--primary); }
        input:checked + .toggle-slider:before { transform: translateX(34px); }

        select { background: var(--glass); color:var(--text); border:2px solid var(--glass-border); border-radius:var(--radius); padding:16px 24px; font-size:18px; min-width:240px; backdrop-filter: blur(20px); transition:var(--transition); }
        select:hover { border-color:var(--primary); }

        .faq-question { font-size:22px; font-weight:700; cursor:pointer; display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
        .faq-answer { max-height:0; overflow:hidden; transition:max-height 0.5s ease; color:var(--text-muted); line-height:1.7; }
        .faq-answer.active { max-height:500px; }

        footer { text-align:center; padding:60px 0; margin-top:100px; border-top:1px solid var(--glass-border); color:var(--text-muted); background: rgba(15,23,42,0.9); backdrop-filter: blur(20px); }
        footer p { margin-bottom:16px; font-size:16px; }
        footer a { color:var(--primary); text-decoration:none; transition:var(--transition); }
        footer a:hover { color:var(--accent); text-decoration:underline; }

        @media (max-width:1024px) {
            .results-grid { grid-template-columns: repeat(2,1fr); }
            .history-stats, .server-stats { flex-direction:column; gap:20px; }
        }

        @media (max-width:768px) {
            .hamburger { display:flex; }
            nav { position:fixed; top:0; right:-100%; width:100%; height:100vh; background: rgba(15,23,42,0.98); backdrop-filter: blur(30px); flex-direction:column; justify-content:center; align-items:center; transition:right 0.6s cubic-bezier(0.4,0,0.2,1); z-index:1000; }
            nav.active { right:0; }
            nav ul { flex-direction:column; gap:30px; text-align:center; }
            nav a { font-size:24px; padding:20px 40px; }
            .page-header h1 { font-size:42px; }
            .test-container, .content-container { padding:40px 24px; }
            .results-grid { grid-template-columns:1fr; }
            .test-controls { flex-direction:column; align-items:center; }
            .btn { width:100%; max-width:400px; }
            .setting-item { flex-direction:column; align-items:flex-start; gap:25px; }
        }

        @media (max-width:480px) {
            .page-header h1 { font-size:36px; }
            .page-header p { font-size:18px; }
            .result-value { font-size:48px; }
            .btn { padding:20px 32px; font-size:18px; min-width:unset; }
        }

        /* small server selection visuals */
        .server-actions .server-select { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
        .server-actions .server-select .custom-input { min-width:320px; max-width:420px; }
        .server-item .use-btn { margin-top:12px; display:inline-block; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon">P</div>
                <div class="logo-text">Pingora</div>
            </div>

            <button class="hamburger" id="hamburger">
                <span></span><span></span><span></span>
            </button>

            <nav id="nav">
                <ul>
                    <li><a href="#" class="nav-link active" data-page="speed-test"><i class="nav-icon fas fa-bolt"></i> Speed Test</a></li>
                    <li><a href="#" class="nav-link" data-page="results"><i class="nav-icon fas fa-chart-bar"></i> Results</a></li>
                    <li><a href="#" class="nav-link" data-page="servers"><i class="nav-icon fas fa-server"></i> Servers</a></li>
                    <li><a href="#" class="nav-link" data-page="settings"><i class="nav-icon fas fa-cog"></i> Settings</a></li>
                    <li><a href="#" class="nav-link" data-page="help"><i class="nav-icon fas fa-question-circle"></i> Help</a></li>
                </ul>
            </nav>
        </header>

        <main>
            <!-- Speed Test Page -->
            <section id="speed-test" class="page active">
                <div class="page-header">
                    <h1>Internet Speed Test</h1>
                    <p>Measure your download, upload, and latency using Cloudflare's global edge network. Get accurate, real-time results in seconds.</p>
                </div>

                <div class="test-container">
                    <div class="visualization">
                        <div class="speed-gauge" id="speed-gauge"></div>
                    </div>

                    <div class="results-grid">
                        <div class="result-card" id="ping"><h3>Ping</h3><div class="result-value">--</div><div class="result-unit">ms</div></div>
                        <div class="result-card" id="download"><h3>Download</h3><div class="result-value">--</div><div class="result-unit">Mbps</div></div>
                        <div class="result-card" id="upload"><h3>Upload</h3><div class="result-value">--</div><div class="result-unit">Mbps</div></div>
                        <div class="result-card" id="jitter"><h3>Jitter</h3><div class="result-value">--</div><div class="result-unit">ms</div></div>
                    </div>

                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill"></div>
                        </div>
                        <div class="progress-text">
                            <span id="progress-status">Ready to start test</span>
                            <span id="progress-percent">0%</span>
                        </div>
                    </div>

                    <div class="test-controls">
                        <button class="btn btn-primary" id="start-test"><i class="fas fa-play"></i> Start Speed Test</button>
                        <button class="btn btn-secondary" id="stop-test" disabled><i class="fas fa-stop"></i> Stop Test</button>
                    </div>
                </div>
            </section>

            <!-- Results Page -->
            <section id="results" class="page">
                <div class="page-header">
                    <h1>Test History</h1>
                    <p>Review your previous speed test results and track performance trends over time.</p>
                </div>

                <div class="content-container">
                    <div class="history-actions" style="margin-bottom:40px; display:flex; gap:20px; flex-wrap:wrap;">
                        <button class="btn btn-secondary" id="clear-history" style="min-width:auto; padding:16px 32px;"><i class="fas fa-trash"></i> Clear History</button>
                        <button class="btn btn-secondary" id="export-history" style="min-width:auto; padding:16px 32px;"><i class="fas fa-download"></i> Export CSV</button>
                    </div>
                    <ul class="history-list" id="history-list"></ul>
                </div>
            </section>

            <!-- Servers Page -->
            <section id="servers" class="page">
                <div class="page-header">
                    <h1>Test Servers</h1>
                    <p>Select from Cloudflare's global edge network or add a custom test server (overrides download/upload endpoints).</p>
                </div>

                <div class="content-container">
                    <div class="server-actions" style="margin-bottom:40px; display:flex; gap:20px; align-items:center; flex-wrap:wrap;">
                        <div class="server-select">
                            <button class="btn btn-secondary" id="refresh-servers" style="min-width:auto; padding:16px 32px;">
                                <i class="fas fa-sync-alt"></i> Refresh Servers
                            </button>
                            <span id="server-count" style="color:var(--text-muted); font-size:18px;">Loading servers...</span>
                            <!-- Quick custom endpoint fields -->
                            <label style="display:flex; gap:8px; align-items:center;">
                                <input id="custom-down-url" class="custom-input" placeholder="Custom download API URL (optional)" style="padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,0.06); background:transparent; color:var(--text);" />
                            </label>
                            <label style="display:flex; gap:8px; align-items:center;">
                                <input id="custom-up-url" class="custom-input" placeholder="Custom upload API URL (optional)" style="padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,0.06); background:transparent; color:var(--text);" />
                            </label>
                            <button class="btn btn-primary" id="apply-custom-server" style="min-width:auto; padding:12px 20px;">Apply Custom</button>
                        </div>
                    </div>

                    <ul class="server-list" id="server-list"></ul>
                </div>
            </section>

            <!-- Settings Page -->
            <section id="settings" class="page">
                <div class="page-header">
                    <h1>Settings</h1>
                    <p>Customize your speed test experience with advanced configuration options.</p>
                </div>

                <div class="content-container">
                    <div class="settings-group">
                        <h3 style="font-size:28px; margin-bottom:40px; color:var(--text); display:flex; align-items:center; gap:15px;">
                            <i class="fas fa-sliders-h" style="color:var(--primary);"></i> Test Configuration
                        </h3>

                        <div class="setting-item" style="display:flex; justify-content:space-between; align-items:center;">
                            <div class="setting-info">
                                <h4 style="font-size:22px; margin-bottom:10px; color:var(--text);">Enable Jitter Measurement</h4>
                                <p style="color:var(--text-muted); font-size:16px; max-width:600px;">Measure network jitter during speed tests for more detailed results.</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="jitter-toggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>

                        <div class="setting-item" style="display:flex; justify-content:space-between; align-items:center;">
                            <div class="setting-info">
                                <h4 style="font-size:22px; margin-bottom:10px; color:var(--text);">Test Duration</h4>
                                <p style="color:var(--text-muted); font-size:16px; max-width:600px;">Duration of download and upload tests for accuracy vs speed.</p>
                            </div>
                            <select id="test-duration">
                                <option value="5000">5 seconds (Quick)</option>
                                <option value="10000" selected>10 seconds (Standard)</option>
                                <option value="15000">15 seconds (Detailed)</option>
                                <option value="20000">20 seconds (Comprehensive)</option>
                            </select>
                        </div>

                        <div class="setting-item" style="display:flex; justify-content:space-between; align-items:center;">
                            <div class="setting-info">
                                <h4 style="font-size:22px; margin-bottom:10px; color:var(--text);">Measurement Units</h4>
                                <p style="color:var(--text-muted); font-size:16px; max-width:600px;">Display speeds in megabits or megabytes per second.</p>
                            </div>
                            <select id="measurement-units">
                                <option value="Mbps" selected>Mbps (Megabits per second)</option>
                                <option value="MBps">MB/s (Megabytes per second)</option>
                            </select>
                        </div>
                    </div>

                    <div class="settings-group">
                        <h3 style="font-size:28px; margin-bottom:40px; color:var(--text); display:flex; align-items:center; gap:15px;"><i class="fas fa-bell" style="color:var(--primary);"></i> Notifications</h3>

                        <div class="setting-item" style="display:flex; justify-content:space-between; align-items:center;">
                            <div class="setting-info">
                                <h4 style="font-size:22px; margin-bottom:10px; color:var(--text);">Test Completion Alerts</h4>
                                <p style="color:var(--text-muted); font-size:16px; max-width:600px;">Show notification when speed test finishes.</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="notifications-toggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>

                        <div class="setting-item" style="display:flex; justify-content:space-between; align-items:center;">
                            <div class="setting-info">
                                <h4 style="font-size:22px; margin-bottom:10px; color:var(--text);">Auto-Save Results</h4>
                                <p style="color:var(--text-muted); font-size:16px; max-width:600px;">Automatically save all test results to history.</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="autosave-toggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>

                    <div class="settings-group">
                        <h3 style="font-size:28px; margin-bottom:40px; color:var(--text); display:flex; align-items:center; gap:15px;"><i class="fas fa-paint-brush" style="color:var(--primary);"></i> Appearance</h3>

                        <div class="setting-item" style="display:flex; justify-content:space-between; align-items:center;">
                            <div class="setting-info">
                                <h4 style="font-size:22px; margin-bottom:10px; color:var(--text);">Theme</h4>
                                <p style="color:var(--text-muted); font-size:16px; max-width:600px;">Choose between dark and light interface themes.</p>
                            </div>
                            <select id="theme-selector">
                                <option value="dark" selected>Dark Theme</option>
                                <option value="light">Light Theme</option>
                                <option value="auto">Auto (System)</option>
                            </select>
                        </div>

                        <div class="setting-item" style="display:flex; justify-content:space-between; align-items:center;">
                            <div class="setting-info">
                                <h4 style="font-size:22px; margin-bottom:10px; color:var(--text);">Animation Effects</h4>
                                <p style="color:var(--text-muted); font-size:16px; max-width:600px;">Enable smooth animations and visual effects.</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="animations-toggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Help Page -->
            <section id="help" class="page">
                <div class="page-header">
                    <h1>Help & Support</h1>
                    <p>Find answers to common questions and get support for Pingora Speed Test.</p>
                </div>

                <div class="content-container">
                    <div class="faq-list">
                        <h3 style="font-size:28px; margin-bottom:40px; color:var(--text);">Frequently Asked Questions</h3>

                        <div class="faq-item">
                            <div class="faq-question">How does the speed test work? <i class="fas fa-chevron-down"></i></div>
                            <div class="faq-answer">
                                <p>Pingora uses Cloudflare's SpeedTest JavaScript module to measure your internet performance. The module downloads and uploads data to Cloudflare's global edge network, calculating your latency (ping), download speed, upload speed, and jitter. The test uses multiple threads to simulate real-world usage and provides accurate results based on Cloudflare's measurement methodology.</p>
                            </div>
                        </div>

                        <div class="faq-item">
                            <div class="faq-question">Why are my results different from other speed tests? <i class="fas fa-chevron-down"></i></div>
                            <div class="faq-answer">
                                <p>Speed test results can vary due to several factors: server location and load, network congestion, time of day, browser extensions, VPN usage, and the testing methodology itself. Pingora uses Cloudflare's network which has servers in 300+ cities worldwide, ensuring consistent and reliable measurements.</p>
                            </div>
                        </div>

                        <div class="faq-item">
                            <div class="faq-question">How can I improve my speed test results? <i class="fas fa-chevron-down"></i></div>
                            <div class="faq-answer">
                                <p>1. Use a wired Ethernet connection instead of Wi-Fi for more stable results<br>
                                2. Close other applications and browser tabs that may use bandwidth<br>
                                3. Disable VPNs or proxy services during testing<br>
                                4. Test at different times of day to identify congestion periods<br>
                                5. Restart your router and modem before testing<br>
                                6. Select a server closer to your physical location</p>
                            </div>
                        </div>

                        <div class="faq-item">
                            <div class="faq-question">Is my data being collected or shared? <i class="fas fa-chevron-down"></i></div>
                            <div class="faq-answer">
                                <p>All test results are stored locally in your browser using localStorage unless you enable custom reporting. We don't collect or transmit personal data from this UI. Cloudflare may collect anonymized measurement data for aggregate insights; check Cloudflare's documentation and privacy policy for details.</p>
                            </div>
                        </div>
                    </div>

                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px,1fr)); gap:40px; margin-top:60px;">
                        <div style="background:var(--glass); backdrop-filter: blur(20px); border-radius:var(--radius); padding:40px; text-align:center; border:1px solid var(--glass-border); transition:var(--transition);">
                            <i class="fas fa-book" style="font-size:48px; color:var(--primary); margin-bottom:25px;"></i>
                            <h4 style="font-size:24px; margin-bottom:15px;">Documentation</h4>
                            <p style="color:var(--text-muted); font-size:16px; margin-bottom:25px;">Read the full documentation and API reference for advanced usage.</p>
                            <button class="btn btn-secondary" style="width:100%;"><i class="fas fa-external-link-alt"></i> View Docs</button>
                        </div>

                        <div style="background:var(--glass); backdrop-filter: blur(20px); border-radius:var(--radius); padding:40px; text-align:center; border:1px solid var(--glass-border); transition:var(--transition);">
                            <i class="fas fa-bug" style="font-size:48px; color:var(--primary); margin-bottom:25px;"></i>
                            <h4 style="font-size:24px; margin-bottom:15px;">Report Issue</h4>
                            <p style="color:var(--text-muted); font-size:16px; margin-bottom:25px;">Found a bug or have a feature request? Let us know on GitHub.</p>
                            <button class="btn btn-secondary" style="width:100%;"><i class="fab fa-github"></i> GitHub Issues</button>
                        </div>

                        <div style="background:var(--glass); backdrop-filter: blur(20px); border-radius:var(--radius); padding:40px; text-align:center; border:1px solid var(--glass-border); transition:var(--transition);">
                            <i class="fas fa-envelope" style="font-size:48px; color:var(--primary); margin-bottom:25px;"></i>
                            <h4 style="font-size:24px; margin-bottom:15px;">Contact Support</h4>
                            <p style="color:var(--text-muted); font-size:16px; margin-bottom:25px;">Email us at support@pingora.example.com for direct assistance.</p>
                            <button class="btn btn-secondary" style="width:100%;"><i class="fas fa-paper-plane"></i> Send Email</button>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <footer>
            <p>Pingora Speed Test v4.0 • Powered by Cloudflare SpeedTest API • <a href="#">Privacy Policy</a> | <a href="#">Terms of Service</a></p>
            <p>© 2025 Pingora Networks. All rights reserved. Cloudflare is a trademark of Cloudflare, Inc.</p>
        </footer>
    </div>

    <script>
        // -------------------------
        // State management
        // -------------------------
        const state = {
            testInProgress: false,
            currentTest: null,
            history: JSON.parse(localStorage.getItem('pingora_history')) || [],
            settings: JSON.parse(localStorage.getItem('pingora_settings')) || {
                jitter: true,
                duration: 10000,
                units: 'Mbps',
                notifications: true,
                autosave: true,
                theme: 'dark',
                animations: true
            },
            // Servers list includes optional download/upload endpoints
            servers: [
                {
                    id: 1,
                    name: 'Cloudflare Global Edge (Auto)',
                    location: 'Automatic',
                    country: 'Global',
                    ping: '--',
                    distance: 'Optimal',
                    status: 'online',
                    downloadApiUrl: 'https://speed.cloudflare.com/__down',
                    uploadApiUrl: 'https://speed.cloudflare.com/__up'
                },
                {
                    id: 2,
                    name: 'North America (Ashburn, VA)',
                    location: 'Ashburn, VA',
                    country: 'US',
                    ping: '12',
                    distance: '0 km',
                    status: 'online',
                    downloadApiUrl: 'https://speed.cloudflare.com/__down', // use same default (Cloudflare auto routes)
                    uploadApiUrl: 'https://speed.cloudflare.com/__up'
                },
                {
                    id: 3,
                    name: 'Europe (Frankfurt)',
                    location: 'Frankfurt',
                    country: 'DE',
                    ping: '28',
                    distance: '6,500 km',
                    status: 'online',
                    downloadApiUrl: 'https://speed.cloudflare.com/__down',
                    uploadApiUrl: 'https://speed.cloudflare.com/__up'
                },
                {
                    id: 4,
                    name: 'Asia Pacific (Singapore)',
                    location: 'Singapore',
                    country: 'SG',
                    ping: '150',
                    distance: '15,300 km',
                    status: 'online',
                    downloadApiUrl: 'https://speed.cloudflare.com/__down',
                    uploadApiUrl: 'https://speed.cloudflare.com/__up'
                }
            ],
            selectedServer: null,
            customServer: { downloadApiUrl: '', uploadApiUrl: '' }
        };

        // -------------------------
        // DOM Elements
        // -------------------------
        const hamburger = document.getElementById('hamburger');
        const nav = document.getElementById('nav');
        const pages = document.querySelectorAll('.page');
        const navLinks = document.querySelectorAll('.nav-link');
        const startBtn = document.getElementById('start-test');
        const stopBtn = document.getElementById('stop-test');
        const progressFill = document.getElementById('progress-fill');
        const progressStatus = document.getElementById('progress-status');
        const progressPercent = document.getElementById('progress-percent');
        const speedGauge = document.getElementById('speed-gauge');
        const historyList = document.getElementById('history-list');
        const serverList = document.getElementById('server-list');
        const serverCount = document.getElementById('server-count');

        // Result elements
        const pingEl = document.querySelector('#ping .result-value');
        const downloadEl = document.querySelector('#download .result-value');
        const uploadEl = document.querySelector('#upload .result-value');
        const jitterEl = document.querySelector('#jitter .result-value');

        // Settings elements
        const jitterToggle = document.getElementById('jitter-toggle');
        const testDuration = document.getElementById('test-duration');
        const measurementUnits = document.getElementById('measurement-units');
        const notificationsToggle = document.getElementById('notifications-toggle');
        const autosaveToggle = document.getElementById('autosave-toggle');
        const themeSelector = document.getElementById('theme-selector');
        const animationsToggle = document.getElementById('animations-toggle');

        // Servers inputs
        const customDownInput = document.getElementById('custom-down-url');
        const customUpInput = document.getElementById('custom-up-url');
        const applyCustomBtn = document.getElementById('apply-custom-server');

        // -------------------------
        // Initialization
        // -------------------------
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            renderHistory();
            renderServers();
            setupEventListeners();
            initNavigation();
            initFAQ();

            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().catch(()=>{});
            }
        });

        // -------------------------
        // Hamburger Menu
        // -------------------------
        hamburger.addEventListener('click', function() {
            hamburger.classList.toggle('active');
            nav.classList.toggle('active');
        });

        // -------------------------
        // Navigation
        // -------------------------
        function initNavigation() {
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (window.innerWidth <= 768) {
                        hamburger.classList.remove('active');
                        nav.classList.remove('active');
                    }
                    const pageId = this.dataset.page;
                    navLinks.forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                    pages.forEach(page => page.classList.remove('active'));
                    document.getElementById(pageId).classList.add('active');
                    document.title = `Pingora • ${this.textContent.trim()}`;
                });
            });
        }

        // -------------------------
        // Settings Management
        // -------------------------
        function loadSettings() {
            jitterToggle.checked = state.settings.jitter;
            testDuration.value = state.settings.duration;
            measurementUnits.value = state.settings.units;
            notificationsToggle.checked = state.settings.notifications;
            autosaveToggle.checked = state.settings.autosave;
            themeSelector.value = state.settings.theme;
            animationsToggle.checked = state.settings.animations;
            applyTheme();
        }

        function saveSettings() {
            state.settings = {
                jitter: jitterToggle.checked,
                duration: parseInt(testDuration.value),
                units: measurementUnits.value,
                notifications: notificationsToggle.checked,
                autosave: autosaveToggle.checked,
                theme: themeSelector.value,
                animations: animationsToggle.checked
            };
            localStorage.setItem('pingora_settings', JSON.stringify(state.settings));
            applyTheme();
        }

        function applyTheme() {
            document.documentElement.setAttribute('data-theme', state.settings.theme);
            if (!state.settings.animations) {
                document.documentElement.style.setProperty('--transition', 'none');
            } else {
                document.documentElement.style.setProperty('--transition', 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)');
            }
        }

        // -------------------------
        // Event Listeners
        // -------------------------
        function setupEventListeners() {
            startBtn.addEventListener('click', startSpeedTest);
            stopBtn.addEventListener('click', stopSpeedTest);

            jitterToggle.addEventListener('change', saveSettings);
            testDuration.addEventListener('change', saveSettings);
            measurementUnits.addEventListener('change', saveSettings);
            notificationsToggle.addEventListener('change', saveSettings);
            autosaveToggle.addEventListener('change', saveSettings);
            themeSelector.addEventListener('change', saveSettings);
            animationsToggle.addEventListener('change', saveSettings);

            document.getElementById('clear-history')?.addEventListener('click', clearHistory);
            document.getElementById('export-history')?.addEventListener('click', exportHistory);
            document.getElementById('refresh-servers')?.addEventListener('click', renderServers);

            applyCustomBtn?.addEventListener('click', () => {
                const down = (customDownInput?.value || '').trim();
                const up = (customUpInput?.value || '').trim();
                if (!down && !up) {
                    alert('Enter at least one custom API URL (download or upload).');
                    return;
                }
                state.customServer = { downloadApiUrl: down || '', uploadApiUrl: up || '' };
                state.selectedServer = { id: 'custom', name: 'Custom Server', downloadApiUrl: down || '', uploadApiUrl: up || '' };
                renderServers();
                alert('Custom server applied. Start a test to use it.');
            });
        }

        // -------------------------
        // FAQ Accordion
        // -------------------------
        function initFAQ() {
            document.querySelectorAll('.faq-question').forEach(question => {
                question.addEventListener('click', function() {
                    const answer = this.nextElementSibling;
                    const icon = this.querySelector('i');
                    answer.classList.toggle('active');
                    if (answer.classList.contains('active')) icon.className = 'fas fa-chevron-up';
                    else icon.className = 'fas fa-chevron-down';
                });
            });
        }

        // -------------------------
        // Helper utilities
        // -------------------------
        function clamp(v, a, b) { return Math.max(a, Math.min(b, v)); }
        function fmtMbpsFromBps(bps) { return (bps / 1_000_000); }
        function setProgress(percent, statusText) {
            percent = clamp(percent, 0, 100);
            progressFill.style.width = `${percent}%`;
            progressPercent.textContent = `${Math.round(percent)}%`;
            if (statusText) progressStatus.textContent = statusText;
        }

        // -------------------------
        // Speed Test: start / stop
        // -------------------------
        async function startSpeedTest() {
            if (state.testInProgress) return;

            state.testInProgress = true;
            startBtn.disabled = true;
            stopBtn.disabled = false;

            // reset UI
            pingEl.textContent = '--';
            downloadEl.textContent = '--';
            uploadEl.textContent = '--';
            jitterEl.textContent = '--';
            progressFill.style.width = '0%';
            progressPercent.textContent = '0%';
            progressStatus.textContent = 'Initializing test...';
            speedGauge.style.height = '0%';
            document.querySelectorAll('.result-card').forEach(card => card.classList.remove('active'));

            try {
                if (typeof window.SpeedTest === 'undefined') {
                    throw new Error('Cloudflare SpeedTest module not loaded');
                }

                // build config, include custom server URLs if selected
                const cfg = {
                    autoStart: false,
                    measurements: [
                        { type: 'latency', numPackets: 10 },
                        { type: 'download' },
                        { type: 'upload' }
                    ],
                    bandwidthFinishRequestDuration: state.settings.duration,
                    measureDownloadLoadedLatency: !!state.settings.jitter,
                    measureUploadLoadedLatency: !!state.settings.jitter
                };

                if (state.selectedServer && (state.selectedServer.downloadApiUrl || state.selectedServer.uploadApiUrl)) {
                    if (state.selectedServer.downloadApiUrl) cfg.downloadApiUrl = state.selectedServer.downloadApiUrl;
                    if (state.selectedServer.uploadApiUrl) cfg.uploadApiUrl = state.selectedServer.uploadApiUrl;
                } else if (state.customServer && (state.customServer.downloadApiUrl || state.customServer.uploadApiUrl)) {
                    if (state.customServer.downloadApiUrl) cfg.downloadApiUrl = state.customServer.downloadApiUrl;
                    if (state.customServer.uploadApiUrl) cfg.uploadApiUrl = state.customServer.uploadApiUrl;
                }

                const st = new window.SpeedTest(cfg);
                state.currentTest = st;

                // smoothing cache for UI progress
                let currentPhase = 'init'; // 'latency' | 'download' | 'upload' | 'finish'
                let lastDownloadBps = 0;
                let lastUploadBps = 0;
                let smoothingDownload = 0;
                let smoothingUpload = 0;

                const lastPoint = (arr) => (Array.isArray(arr) && arr.length ? arr[arr.length - 1] : null);

                // onResultsChange: update intermediate metrics & progress mapping
                st.onResultsChange = (info) => {
                    try {
                        if (!info || !info.type) return;

                        if (info.type === 'latency') {
                            currentPhase = 'latency';
                            // prefer getUnloadedLatency if available
                            const unloaded = st.results && typeof st.results.getUnloadedLatency === 'function' ? st.results.getUnloadedLatency() : null;
                            if (typeof unloaded === 'number') {
                                pingEl.textContent = unloaded.toFixed(1);
                            } else {
                                // fallback to points
                                const points = st.results && st.results.getUnloadedLatencyPoints ? st.results.getUnloadedLatencyPoints() || [] : [];
                                if (points.length) pingEl.textContent = points[points.length - 1].toFixed(1);
                            }

                            if (state.settings.jitter && st.results && typeof st.results.getUnloadedJitter === 'function') {
                                const j = st.results.getUnloadedJitter();
                                if (typeof j === 'number') jitterEl.textContent = j.toFixed(1);
                            }

                            // latency maps to 0-12%
                            setProgress(10, 'Testing latency...');
                            document.getElementById('ping').classList.add('active');
                        }

                        if (info.type === 'download') {
                            currentPhase = 'download';
                            const dpoints = st.results && typeof st.results.getDownloadBandwidthPoints === 'function' ? st.results.getDownloadBandwidthPoints() || [] : [];
                            const last = lastPoint(dpoints);
                            if (last && last.bps) {
                                lastDownloadBps = last.bps;
                                // exponential smoothing for UI
                                smoothingDownload = smoothingDownload * 0.85 + lastDownloadBps * 0.15;
                                const speedMbps = fmtMbpsFromBps(smoothingDownload);
                                downloadEl.textContent = speedMbps.toFixed(1);

                                // map speed to percent range 12 -> 72
                                // chosen heuristic: log scale to avoid linear cap at high speeds
                                const normalized = Math.log10(speedMbps + 1) / 4; // expected scale
                                const pct = 12 + clamp(normalized * 60, 0, 60);
                                setProgress(pct, 'Testing download speed...');
                                document.getElementById('ping').classList.remove('active');
                                document.getElementById('download').classList.add('active');

                                // gauge height heuristic (normalized to 0-100)
                                const gaugeHeight = clamp((smoothingDownload / 1_000_000_000) * 100, 2, 100);
                                speedGauge.style.height = `${gaugeHeight}%`;
                            } else {
                                setProgress(20, 'Testing download speed...');
                            }
                        }

                        if (info.type === 'upload') {
                            currentPhase = 'upload';
                            const upoints = st.results && typeof st.results.getUploadBandwidthPoints === 'function' ? st.results.getUploadBandwidthPoints() || [] : [];
                            const last = lastPoint(upoints);
                            if (last && last.bps) {
                                lastUploadBps = last.bps;
                                smoothingUpload = smoothingUpload * 0.85 + lastUploadBps * 0.15;
                                const speedMbps = fmtMbpsFromBps(smoothingUpload);
                                uploadEl.textContent = speedMbps.toFixed(1);

                                // map speed to percent range 72 -> 96
                                const normalized = Math.log10(speedMbps + 1) / 4;
                                const pct = 72 + clamp(normalized * 24, 0, 24);
                                setProgress(pct, 'Testing upload speed...');
                                document.getElementById('download').classList.remove('active');
                                document.getElementById('upload').classList.add('active');

                                speedGauge.style.background = 'linear-gradient(to top, var(--secondary), var(--accent))';
                            } else {
                                setProgress(76, 'Testing upload speed...');
                            }
                        }
                    } catch (err) {
                        console.warn('onResultsChange handler error', err);
                    }
                };

                st.onRunningChange = (running) => {
                    if (running) {
                        progressStatus.textContent = 'Running test...';
                    }
                };

                st.onFinish = (results) => {
                    try {
                        const finalPing = results && typeof results.getUnloadedLatency === 'function' ? results.getUnloadedLatency() : (parseFloat(pingEl.textContent) || 0);
                        const finalDownloadBps = results && typeof results.getDownloadBandwidth === 'function' ? results.getDownloadBandwidth() : (parseFloat(downloadEl.textContent) * 1_000_000 || 0);
                        const finalUploadBps = results && typeof results.getUploadBandwidth === 'function' ? results.getUploadBandwidth() : (parseFloat(uploadEl.textContent) * 1_000_000 || 0);
                        const finalJitter = results && typeof results.getUnloadedJitter === 'function' ? results.getUnloadedJitter() : (parseFloat(jitterEl.textContent) || 0);

                        if (typeof finalPing === 'number') pingEl.textContent = finalPing.toFixed(1);
                        if (typeof finalDownloadBps === 'number') downloadEl.textContent = fmtMbpsFromBps(finalDownloadBps).toFixed(1);
                        if (typeof finalUploadBps === 'number') uploadEl.textContent = fmtMbpsFromBps(finalUploadBps).toFixed(1);
                        if (state.settings.jitter && typeof finalJitter === 'number') jitterEl.textContent = finalJitter.toFixed(1);

                        setProgress(100, 'Test complete!');
                        speedGauge.style.height = '0%';
                        speedGauge.style.background = 'linear-gradient(to top, var(--primary), var(--secondary))';

                        if (state.settings.autosave) {
                            saveToHistory({
                                timestamp: new Date().toISOString(),
                                ping: finalPing,
                                download: fmtMbpsFromBps(finalDownloadBps),
                                upload: fmtMbpsFromBps(finalUploadBps),
                                jitter: finalJitter,
                                server: state.selectedServer ? state.selectedServer.name : 'Cloudflare Edge',
                                isp: 'N/A',
                                ip: 'N/A'
                            });
                        }

                        if (state.settings.notifications && Notification.permission === 'granted') {
                            new Notification('Pingora Speed Test Complete', {
                                body: `Download: ${fmtMbpsFromBps(finalDownloadBps).toFixed(1)} Mbps, Upload: ${fmtMbpsFromBps(finalUploadBps).toFixed(1)} Mbps, Ping: ${finalPing.toFixed(1)} ms`
                            });
                        }
                    } catch (err) {
                        console.warn('Error parsing final results:', err);
                    } finally {
                        state.testInProgress = false;
                        startBtn.disabled = false;
                        stopBtn.disabled = true;
                    }
                };

                st.onError = (err) => {
                    console.error('SpeedTest error:', err);
                    progressStatus.textContent = `Error: ${err}`;
                    state.testInProgress = false;
                    startBtn.disabled = false;
                    stopBtn.disabled = true;
                };

                // Start the test
                if (typeof st.play === 'function') st.play();
                else if (typeof st.restart === 'function') st.restart();
                else throw new Error('SpeedTest instance missing play/restart methods');

            } catch (error) {
                console.error('Speed test error:', error);
                progressStatus.textContent = 'Using simulation mode...';
                simulateSpeedTest();
            }
        }

        function stopSpeedTest() {
            if (state.currentTest) {
                if (typeof state.currentTest.pause === 'function') {
                    try { state.currentTest.pause(); } catch(e) { console.warn('pause failed', e); }
                } else if (typeof state.currentTest.restart === 'function') {
                    // no clean pause available; try a restart or remove reference
                    try { state.currentTest.restart(); } catch(e) {}
                }
            }

            state.testInProgress = false;
            startBtn.disabled = false;
            stopBtn.disabled = true;
            progressStatus.textContent = 'Test stopped';
            speedGauge.style.height = '0%';
        }

        // -------------------------
        // Simulation fallback
        // -------------------------
        function simulateSpeedTest() {
            state.testInProgress = true;
            let progress = 0;
            const interval = setInterval(() => {
                if (!state.testInProgress) {
                    clearInterval(interval);
                    return;
                }

                progress += 2;
                progressFill.style.width = `${progress}%`;
                progressPercent.textContent = `${progress}%`;

                if (progress < 20) {
                    progressStatus.textContent = 'Testing latency...';
                    document.getElementById('ping').classList.add('active');
                    if (progress >= 15) {
                        pingEl.textContent = (Math.random() * 20 + 5).toFixed(1);
                        jitterEl.textContent = (Math.random() * 5 + 1).toFixed(1);
                    }
                } else if (progress < 60) {
                    progressStatus.textContent = 'Testing download speed...';
                    document.getElementById('ping').classList.remove('active');
                    document.getElementById('download').classList.add('active');

                    const downloadSpeed = 100 + Math.random() * 400;
                    downloadEl.textContent = downloadSpeed.toFixed(1);
                    speedGauge.style.height = `${(progress - 20) / 40 * 100}%`;
                } else if (progress < 100) {
                    progressStatus.textContent = 'Testing upload speed...';
                    document.getElementById('download').classList.remove('active');
                    document.getElementById('upload').classList.add('active');

                    const uploadSpeed = 20 + Math.random() * 100;
                    uploadEl.textContent = uploadSpeed.toFixed(1);
                    speedGauge.style.background = 'linear-gradient(to top, var(--secondary), var(--accent))';
                } else {
                    clearInterval(interval);
                    progressStatus.textContent = 'Test complete!';

                    if (state.settings.autosave) {
                        saveToHistory({
                            timestamp: new Date().toISOString(),
                            ping: parseFloat(pingEl.textContent),
                            download: parseFloat(downloadEl.textContent),
                            upload: parseFloat(uploadEl.textContent),
                            jitter: parseFloat(jitterEl.textContent),
                            server: 'Simulation Server',
                            isp: 'Demo ISP',
                            ip: '192.168.1.1'
                        });
                    }

                    state.testInProgress = false;
                    startBtn.disabled = false;
                    stopBtn.disabled = true;
                }
            }, 100);
        }

        // -------------------------
        // History Management
        // -------------------------
        function saveToHistory(result) {
            state.history.unshift(result);
            if (state.history.length > 50) state.history.pop();
            localStorage.setItem('pingora_history', JSON.stringify(state.history));
            renderHistory();
        }

        function renderHistory() {
            if (!historyList) return;
            historyList.innerHTML = '';
            if (state.history.length === 0) {
                historyList.innerHTML = `
                    <li class="history-item" style="text-align:center; color:var(--text-muted); padding:60px;">
                        <i class="fas fa-history" style="font-size:60px; margin-bottom:25px; display:block; opacity:0.5;"></i>
                        <h4 style="font-size:24px; margin-bottom:15px;">No test results yet</h4>
                        <p style="font-size:18px;">Run your first speed test to see results here</p>
                    </li>
                `;
                return;
            }

            state.history.forEach((test, index) => {
                const date = new Date(test.timestamp);
                const formattedDate = date.toLocaleDateString('en-US', { month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' });

                const item = document.createElement('li');
                item.className = 'history-item';
                item.innerHTML = `
                    <div style="flex:1;">
                        <h4 style="font-size:22px; margin-bottom:12px; color:var(--text);">Test #${state.history.length - index}</h4>
                        <p style="color:var(--text-muted); font-size:16px; margin-bottom:8px;">${formattedDate} • ${test.server}</p>
                        <p style="font-size:14px; color:var(--text-muted);">${test.isp} • ${test.ip}</p>
                    </div>
                    <div class="history-stats">
                        <div class="stat-download">
                            <span class="stat-value">${test.download.toFixed(1)}</span>
                            <span class="stat-label">Download</span>
                        </div>
                        <div class="stat-upload">
                            <span class="stat-value">${test.upload.toFixed(1)}</span>
                            <span class="stat-label">Upload</span>
                        </div>
                        <div class="stat-ping">
                            <span class="stat-value">${test.ping.toFixed(1)}</span>
                            <span class="stat-label">Ping</span>
                        </div>
                    </div>
                `;
                historyList.appendChild(item);
            });
        }

        function clearHistory() {
            if (confirm('Are you sure you want to clear all test history? This action cannot be undone.')) {
                state.history = [];
                localStorage.removeItem('pingora_history');
                renderHistory();
            }
        }

        function exportHistory() {
            const csv = ['Timestamp,Download (Mbps),Upload (Mbps),Ping (ms),Jitter (ms),Server,ISP,IP'];
            state.history.forEach(test => {
                csv.push(`"${test.timestamp}",${test.download},${test.upload},${test.ping},${test.jitter || ''},"${test.server || ''}","${test.isp || ''}","${test.ip || ''}"`);
            });
            const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pingora-history-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // -------------------------
        // Server Management & UI
        // -------------------------
        function renderServers() {
            if (!serverList) return;

            serverList.innerHTML = '';
            serverCount.textContent = `${state.servers.length + (state.customServer.downloadApiUrl || state.customServer.uploadApiUrl ? 1 : 0)} servers available`;

            // Add custom server display if present
            if (state.customServer.downloadApiUrl || state.customServer.uploadApiUrl) {
                const item = document.createElement('li');
                item.className = `server-item ${state.selectedServer?.id === 'custom' ? 'selected' : ''}`;
                item.innerHTML = `
                    <div style="flex:1;">
                        <h4 style="font-size:22px; margin-bottom:10px; color:var(--text);">Custom Server</h4>
                        <p style="color:var(--text-muted); font-size:16px;">Download: ${state.customServer.downloadApiUrl || '—'}<br>Upload: ${state.customServer.uploadApiUrl || '—'}</p>
                    </div>
                    <div style="display:flex; flex-direction:column; gap:8px; align-items:flex-end;">
                        <div class="server-stats">
                            <div>
                                <div class="server-ping">—</div>
                                <div class="server-ping-label">Ping</div>
                            </div>
                            <div style="width:12px;"></div>
                            <div class="server-status"></div>
                        </div>
                        <button class="btn btn-primary use-btn" data-id="custom">Use Server</button>
                    </div>
                `;
                item.querySelector('.use-btn').addEventListener('click', () => {
                    state.selectedServer = { id: 'custom', name: 'Custom Server', downloadApiUrl: state.customServer.downloadApiUrl, uploadApiUrl: state.customServer.uploadApiUrl };
                    renderServers();
                    alert('Custom server selected. Start a test to use it.');
                });
                serverList.appendChild(item);
            }

            state.servers.forEach(server => {
                const item = document.createElement('li');
                item.className = `server-item ${state.selectedServer?.id === server.id ? 'selected' : ''}`;
                item.innerHTML = `
                    <div style="flex:1;">
                        <h4 style="font-size:22px; margin-bottom:10px; color:var(--text);">${server.name}</h4>
                        <p style="color:var(--text-muted); font-size:16px;">${server.location}, ${server.country} • ${server.distance}</p>
                    </div>
                    <div style="display:flex; flex-direction:column; gap:8px; align-items:flex-end;">
                        <div class="server-stats">
                            <div>
                                <div class="server-ping">${server.ping} ms</div>
                                <div class="server-ping-label">Ping</div>
                            </div>
                            <div style="width:12px;"></div>
                            <div class="server-status"></div>
                        </div>
                        <button class="btn btn-primary use-btn" data-id="${server.id}">Use Server</button>
                    </div>
                `;

                item.querySelector('.use-btn').addEventListener('click', () => {
                    state.selectedServer = server;
                    renderServers();
                    alert(`Selected server: ${server.name}\nThis selection will override the endpoints the next time you start a test.`);
                });

                serverList.appendChild(item);
            });
        }
    </script>
</body>
</html>
